# DevOps Project: –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –Ω–∞–≥—Ä—É–∑–∫–∏ HAProxy + Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
–ü—Ä–æ–µ–∫—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –≤—ã—Å–æ–∫–æ–¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º:
- **Terraform**: –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞–∫ –∫–æ–¥ (–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã, –ë–î, –≥—Ä—É–ø–ø—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
- **Ansible**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π  
- **HAProxy**: –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏ —Å SSL —Ç–µ—Ä–º–∏–Ω–∞—Ü–∏–µ–π
- **Flask**: Python –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å MySQL –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã
[–ò–Ω—Ç–µ—Ä–Ω–µ—Ç] ‚Üí [HAProxy –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫] ‚Üí [Flask App 1] ‚Üí [MySQL –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö]
‚Üí
[Flask App 2]



## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
```
project/
‚îú‚îÄ‚îÄ ansible/
‚îÇ   ‚îú‚îÄ‚îÄ group_vars/all/ # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (vars.yml, vault.yml)
‚îÇ   ‚îú‚îÄ‚îÄ inventory/ # –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è (hosts.yml)
‚îÇ   ‚îú‚îÄ‚îÄ roles/ # –†–æ–ª–∏ Ansible
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app/ # Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ haproxy/ # HAProxy + SSL
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ hardening/ # –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –û–°
‚îÇ   ‚îî‚îÄ‚îÄ playbook.yml # –û—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–π–±—É–∫
‚îú‚îÄ‚îÄ terraform/
‚îÇ   ‚îú‚îÄ‚îÄ main.tf # –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ database.tf # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ variables.tf # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
‚îÇ   ‚îú‚îÄ‚îÄ outputs.tf # –í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
‚îÇ   ‚îî‚îÄ‚îÄ vkcs_provider.tf # –ü—Ä–æ–≤–∞–π–¥–µ—Ä VK Cloud
‚îî‚îÄ‚îÄ README.md # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```
## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å Terraform
```bash
cd terraform

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
terraform init

# –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
terraform plan \
  -var="username=–í–ê–®_EMAIL" \
  -var="password=–í–ê–®_–ü–ê–†–û–õ–¨" \
  -var="project_id=–í–ê–®_PROJECT_ID" \
  -var="lastname=–í–ê–®–ê_–§–ê–ú–ò–õ–ò–Ø" \
  -var="ssh_public_key=$(cat ~/.ssh/id_rsa.pub)"

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
terraform apply [–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞–∫ –≤—ã—à–µ]
2. –ü–æ–ª—É—á–µ–Ω–∏–µ IP –∞–¥—Ä–µ—Å–æ–≤
–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è terraform apply –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –≤—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:


Outputs:

application_urls = {
  "app_servers" = [
    "http://192.168.100.249:5000",  # –ü–†–ò–í–ê–¢–ù–´–ô IP app1
    "http://192.168.100.192:5000",  # –ü–†–ò–í–ê–¢–ù–´–ô IP app2
  ]
  "haproxy_public" = "http://212.111.84.45"  # –ü–£–ë–õ–ò–ß–ù–´–ô IP haproxy
}

public_ips = {
  "app1" = "212.111.84.154"      # –ü–£–ë–õ–ò–ß–ù–´–ô IP app1
  "app2" = "212.111.86.216"      # –ü–£–ë–õ–ò–ß–ù–´–ô IP app2
  "haproxy" = "212.111.84.45"    # –ü–£–ë–õ–ò–ß–ù–´–ô IP haproxy
}
3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Ansible Inventory
–û–±–Ω–æ–≤–∏—Ç–µ ansible/inventory/hosts.yml —Å –ø–æ–ª—É—á–µ–Ω–Ω—ã–º–∏ IP:

yaml
all:
  vars:
    ansible_user: ubuntu
    ansible_ssh_private_key_file: ~/.ssh/id_rsa
    ansible_become: yes

app_servers:
  hosts:
    app1:
      ansible_host: "212.111.84.154"      # –ü–£–ë–õ–ò–ß–ù–´–ô IP app1
      private_ip: "192.168.100.249"       # –ü–†–ò–í–ê–¢–ù–´–ô IP app1
    app2:
      ansible_host: "212.111.86.216"      # –ü–£–ë–õ–ò–ß–ù–´–ô IP app2
      private_ip: "192.168.100.192"       # –ü–†–ò–í–ê–¢–ù–´–ô IP app2

haproxy:
  hosts:
    haproxy-server:
      ansible_host: "212.111.84.45"       # –ü–£–ë–õ–ò–ß–ù–´–ô IP haproxy
      private_ip: "192.168.100.193"       # –ü–†–ò–í–ê–¢–ù–´–ô IP haproxy

database:
  hosts:
    db:
      ansible_host: "212.111.86.216"      # –ü–£–ë–õ–ò–ß–ù–´–ô IP Managed MySQL
4. –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º
bash
cd ansible

# –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö SSH –∫–ª—é—á–µ–π
ssh-keygen -f ~/.ssh/known_hosts -R '212.111.84.154'
ssh-keygen -f ~/.ssh/known_hosts -R '212.111.86.216'  
ssh-keygen -f ~/.ssh/known_hosts -R '212.111.84.45'

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∫–ª—é—á–µ–π
ssh-keyscan 212.111.84.154 >> ~/.ssh/known_hosts
ssh-keyscan 212.111.86.216 >> ~/.ssh/known_hosts
ssh-keyscan 212.111.84.45 >> ~/.ssh/known_hosts
5. –ó–∞–ø—É—Å–∫ Ansible –ø–ª–µ–π–±—É–∫–∞
bash
cd ansible

# –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ –ø–ª–µ–π–±—É–∫–∞
ansible-playbook -i inventory/hosts.yml playbook.yml --ask-vault-pass
# –ü–∞—Ä–æ–ª—å vault: 1954
üîê –°–∏—Å—Ç–µ–º–∞ –ø–∞—Ä–æ–ª–µ–π
–ü–∞—Ä–æ–ª—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
–ò—Å—Ç–æ—á–Ω–∏–∫: –ó–∞–¥–∞–µ—Ç—Å—è –≤ Terraform (variables.tf)

hcl
variable "db_password" {
  description = "Database password"
  type        = string
  sensitive   = true
  default     = "7h78gs.p70aG85wU0"  # ‚Üê –ü–∞—Ä–æ–ª—å –ë–î
}
Ansible Vault
–ü–∞—Ä–æ–ª—å: 1954 - –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ —Å–µ–∫—Ä–µ—Ç–æ–≤

–°–æ–¥–µ—Ä–∂–∏–º–æ–µ vault.yml:

yaml
db_password: "7h78gs.p70aG85wU0"  # –ü–∞—Ä–æ–ª—å MySQL (–∏–∑ variables.tf)
secret_key: "dddd"                # –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ vault:
bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–µ–∫—Ä–µ—Ç–æ–≤
ansible-vault view group_vars/all/vault.yml

# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
ansible-vault edit group_vars/all/vault.yml

# –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è
ansible-vault rekey group_vars/all/vault.yml

üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
–ü–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É —Å–∏—Å—Ç–µ–º—ã:

bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTP -> HTTPS —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
curl -I http://212.111.84.45

# –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTPS
curl -k https://212.111.84.45

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏
for i in {1..6}; do
  echo -n "–ó–∞–ø—Ä–æ—Å $i: "
  curl -k -s https://212.111.84.45
  echo
done

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–º–µ–Ω–∞ Let's Encrypt
curl -k https://212-111-84-45.nip.io
üõ†Ô∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
‚úÖ –°–æ–∑–¥–∞–≤–∞–µ–º–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:

3 –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã –≤ —Ä–∞–∑–Ω—ã—Ö –∑–æ–Ω–∞—Ö –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏

Managed MySQL 8.0

–ì—Ä—É–ø–ø—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

HAProxy —Å –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ (round-robin)

Let's Encrypt SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã

Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –¥–≤—É—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö

–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: UFW, fail2ban, —Ö–∞—Ä–¥–µ–Ω–∏–Ω–≥ SSH

üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —Å app-—Å–µ—Ä–≤–µ—Ä–æ–≤

SSH –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –ø–æ –∫–ª—é—á–∞–º

–§–∞–π—Ä–≤–æ–ª —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –æ—Ç–∫—Ä—ã—Ç—ã–º–∏ –ø–æ—Ä—Ç–∞–º–∏

–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ Ansible Vault
